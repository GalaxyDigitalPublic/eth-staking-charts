{{- if .Values.enabled }}
{{- $root := . -}}

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ template "validators.fullname" $root }}
  labels:
    {{- include "validator.labels" $root | nindent 4 }}
spec:
  replicas: {{ $root.Values.validatorsCount }}
  {{- with .Values.podManagementPolicy }}
  podManagementPolicy: {{ . }}
  {{- end }}
  {{- with .Values.updateStrategy }}
  updateStrategy:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "validators.selectorLabels" $root | nindent 6 }}
  serviceName: {{ template "validators.fullname" $root }}
  template:
    metadata:
      labels:
        {{- include "validators.selectorLabels" $root | nindent 8 }}
      {{- with $root.Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    spec:
      {{- with (concat $root.Values.imagePullSecrets $root.Values.global.imagePullSecrets) }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $root.Values.terminationGracePeriodSeconds }}
      terminationGracePeriodSeconds: {{ . }}
      {{- end }}
      {{- with $root.Values.affinity }}
      affinity:
        {{ toYaml . | nindent 8 | trim }}
      {{- end }}
      {{- with $root.Values.tolerations }}
      tolerations:
        {{ toYaml . | nindent 8 | trim }}
      {{- end }}
      {{- with $root.Values.nodeSelector }}
      nodeSelector:
        {{ toYaml . | nindent 8 | trim }}
      {{- end }}
      {{- if .Values.topologySpreadConstraints }}
      topologySpreadConstraints:
        {{- toYaml .Values.topologySpreadConstraints | nindent 8 }}
      {{- end }}
      {{- with $root.Values.securityContext }}
      securityContext:
        {{ toYaml . | nindent 8 | trim }}
      {{- end }}
      serviceAccountName: "validators"
      priorityClassName: {{ $root.Values.priorityClassName | quote }}
      initContainers:
        {{- if $root.Values.web3signerTls.enabled }}
        # Convert PEM certificates to PKCS#12 format for Lighthouse
        - name: convert-certs-p12
          image: "{{ $root.Values.web3signerTls.opensslImage.registry }}/{{ $root.Values.web3signerTls.opensslImage.repository }}:{{ $root.Values.web3signerTls.opensslImage.tag }}"
          imagePullPolicy: {{ $root.Values.web3signerTls.opensslImage.pullPolicy }}
          securityContext:
            runAsUser: 0
          command:
            - sh
            - -c
            - |
              set -e
              echo "Converting PEM certificates to PKCS#12 format..."
              # Convert PEM cert+key to PKCS#12
              openssl pkcs12 -export \
                -in /certs-pem/tls.crt \
                -inkey /certs-pem/tls.key \
                -out /tls/client.p12 \
                -passout pass:${P12_PASSWORD} \
                -name "web3signer-client"
              # Copy CA cert
              cp /certs-pem/ca.crt /tls/ca.crt
              # Write password to file for Lighthouse
              echo -n "${P12_PASSWORD}" > /tls/client.password
              # Set permissions
              chmod 644 /tls/*
              chown {{ $root.Values.securityContext.runAsUser }}:{{ $root.Values.securityContext.runAsUser }} /tls/*
              echo "Certificate conversion complete"
              ls -la /tls/
          env:
            - name: P12_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $root.Values.web3signerTls.p12PasswordSecret.name }}
                  key: {{ $root.Values.web3signerTls.p12PasswordSecret.key }}
          volumeMounts:
            - name: tls-certs-pem
              mountPath: /certs-pem
              readOnly: true
            - name: tls-certs
              mountPath: /tls
        {{- end }}
        - name: get-configs
          image: "{{ $root.Values.cliImage.registry }}/{{ $root.Values.cliImage.repository }}:{{ $root.Values.cliImage.tag }}"
          imagePullPolicy: {{ $root.Values.cliImage.pullPolicy }}
          securityContext:
            runAsUser: 0
          env:
            - name: WEB3SIGNER_URL
              value: {{ $root.Values.web3signerEndpoint }}
          args:
            - "sync-validator-keys"
            - "--db-url"
            - "{{ $root.Values.dbKeystoreUrl }}"
            - "--output-dir"
            - "/data"
            - "--default-recipient"
            - "{{ $root.Values.suggestedFeeRecipient }}"
          volumeMounts:
            - name: data
              mountPath: /data
        {{- if $root.Values.web3signerTls.enabled }}
        # Inject TLS configuration into validator_definitions.yml for Lighthouse
        - name: inject-tls-config
          image: "{{ $root.Values.web3signerTls.yqImage.registry }}/{{ $root.Values.web3signerTls.yqImage.repository }}:{{ $root.Values.web3signerTls.yqImage.tag }}"
          imagePullPolicy: {{ $root.Values.web3signerTls.yqImage.pullPolicy }}
          securityContext:
            runAsUser: 0
          command:
            - sh
            - -c
            - |
              set -e
              echo "Injecting TLS configuration into validator_definitions.yml..."
              yq -i '(.[] | select(.type == "web3signer")) += {
                "root_certificate_path": "{{ $root.Values.web3signerTls.rootCertificatePath }}",
                "client_identity_path": "{{ $root.Values.web3signerTls.clientIdentityPath }}",
                "client_identity_password_path": "{{ $root.Values.web3signerTls.clientIdentityPasswordPath }}"
              }' /data/validator_definitions.yml
              echo "TLS configuration injected:"
              cat /data/validator_definitions.yml
          volumeMounts:
            - name: data
              mountPath: /data
        {{- end }}
        - name: prepare
          image: "{{ $root.Values.initImageBusybox.registry }}/{{ $root.Values.initImageBusybox.repository }}:{{ $root.Values.initImageBusybox.tag }}"
          imagePullPolicy: {{ $root.Values.initImageBusybox.pullPolicy }}
          securityContext:
            runAsUser: 0
          command:
            - sh
            - -c
            - >
              ls -lha /data;
              mkdir -p /data/lighthouse/validators;
              cp /data/validator_definitions.yml /data/lighthouse/validators/validator_definitions.yml;
              cat /data/signer_keys.yml > /data/config;
              cat /data/config;
              cat /data/proposerConfig.json;
              chown -R {{ $root.Values.securityContext.runAsUser }}:{{ $root.Values.securityContext.runAsUser }} /data;
          volumeMounts:
            - name: data
              mountPath: /data
      containers:
        - name: validator
          image: "{{ (pluck $root.Values.type $root.Values.image | first ).registry }}/{{ (pluck $root.Values.type $root.Values.image | first ).repository }}:{{ (pluck $root.Values.type $root.Values.image | first ).tag }}"
          imagePullPolicy: {{ $root.Values.image.pullPolicy }}
          args:
            {{- range (pluck $root.Values.type $root.Values.flags | first) }}
            - {{ . | quote }}
            {{- end -}}

            {{- if eq $root.Values.type "prysm" }}
            - "--{{ $root.Values.network }}"
            - "--config-file=/data/config"
            - "--validators-external-signer-url={{ $.Values.web3signerEndpoint }}"
            {{- else if eq $root.Values.type "lighthouse" }}
            - "--network={{ $root.Values.network }}"
            {{- else if eq $root.Values.type "teku" }}
            - "--network=auto"
            - "--config-file=/data/config"
            - "--validators-external-signer-url={{ $.Values.web3signerEndpoint }}"
            - "--validators-proposer-config=/data/proposerConfig.json"
            {{- end }}

            {{- if eq $root.Values.type "teku" }}
            - "--validators-proposer-default-fee-recipient={{ $.Values.suggestedFeeRecipient }}"
            {{- else }}
            - "--suggested-fee-recipient={{ $.Values.suggestedFeeRecipient }}"
            {{- end }}

            {{- include "validator-graffiti" $ | trim | nindent 12 }}

            {{- include "beacon-rpc-node" $ | trim | nindent 12 }}

            {{- if $root.Values.metrics.enabled }}
            {{- range (pluck $root.Values.type $root.Values.metrics.flags | first) }}
            - {{ . | quote }}
            {{- end }}
            {{- end }}

            {{- if $root.Values.builder.enabled }}
            {{- range (pluck $root.Values.type $root.Values.builder.flags | first) }}
            - {{ . | quote }}
            {{- end }}
            {{- end }}

            {{- if $root.Values.keyManagerApi.enabled }}
            {{- range (pluck $root.Values.type $root.Values.keyManagerApi.flags | first) }}
            - {{ . | quote }}
            {{- end }}
            {{- end }}

            {{- range (pluck $root.Values.type $root.Values.extraFlags | first) }}
            - {{ . | quote }}
            {{- end -}}

          {{- if $root.Values.metrics.enabled }}
          ports:
            - containerPort: {{ $root.Values.metrics.port }}
              name: metrics
              protocol: TCP
          {{- end }}
          {{- with (pluck $root.Values.type $root.Values.readinessProbe | first) }}
          readinessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with (pluck $root.Values.type $root.Values.livenessProbe | first) }}
          livenessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with $root.Values.resources }}
          resources:
            {{ toYaml . | nindent 12 }}
          {{- end }}
          volumeMounts:
            - name: data
              mountPath: /data
          {{- if $root.Values.web3signerTls.enabled }}
            - name: tls-certs
              mountPath: /tls
              readOnly: true
          {{- end }}
          {{- if and $root.Values.keyManagerApi.enabled $root.Values.keyManagerApi.tokenSecret.name }}
            {{- if eq $root.Values.type "prysm" }}
            - name: apitoken
              mountPath: /data/auth-token
              subPath: {{ $root.Values.keyManagerApi.tokenSecret.publicKey }}
            {{- else if eq $root.Values.type "lighthouse" }}
            - name: apitoken
              mountPath: /data/lighthouse/validators/api-token.txt
              subPath: {{ $root.Values.keyManagerApi.tokenSecret.publicKey }}
            - name: apitoken
              mountPath: /data/lighthouse/validators/.secp-sk
              subPath: {{ $root.Values.keyManagerApi.tokenSecret.privateKey }}
            {{- else if eq $root.Values.type "teku" }}
            - name: apitoken
              mountPath: /data/validator/key-manager/validator-api-bearer
              subPath: {{ $root.Values.keyManagerApi.tokenSecret.publicKey }}
            {{- end }}
          {{- end }}
      volumes:
        - name: data
          emptyDir: {}
        {{- if $root.Values.web3signerTls.enabled }}
        - name: tls-certs-pem
          secret:
            secretName: {{ $root.Values.web3signerTls.pemSecret.name }}
        - name: tls-certs
          emptyDir: {}
        {{- end }}
        {{- if and $root.Values.keyManagerApi.enabled $root.Values.keyManagerApi.tokenSecret.name }}
        - name: apitoken
          secret:
            secretName: {{ $root.Values.keyManagerApi.tokenSecret.name }}
        {{- end }}

{{- end }}
