apiVersion: v1
kind: Secret
metadata:
  name: {{ include "common.names.fullname" . }}-config
  labels:
    {{- include "common.labels.standard" . | nindent 4 }}
stringData:
  config.yaml: |
    data-path: "/data/web3signer"
    key-store-path: "/data/keystore"
    eth2.network: {{ .Values.network }}
    logging: {{ .Values.loggingLevel }}
    eth2.slashing-protection-enabled: true
    eth2.slashing-protection-pruning-enabled: true
    eth2.slashing-protection-pruning-epochs-to-keep: {{ .Values.pruningEpochToKeep }}
    eth2.slashing-protection-pruning-interval: {{ .Values.pruningInterval }}
    eth2.slashing-protection-pruning-slots-per-epoch: {{ .Values.slotsPerEpoch }}
    eth2.slashing-protection-db-username: {{ .Values.dbUsername }}
    eth2.slashing-protection-db-password: {{ .Values.dbPassword }}
    eth2.slashing-protection-db-url: {{ .Values.dbUrl }}
    eth2.key-manager-api-enabled: {{ .Values.keyManagerApiEnabled }}
    metrics-enabled: true
    metrics-host: "0.0.0.0"
    metrics-port: {{ .Values.metricsPort }}
    metrics-host-allowlist: ["*"]
    swagger-ui-enabled: true
    http-cors-origins: ["*"]
    http-listen-host: "0.0.0.0"
    http-listen-port: {{ .Values.httpPort }}
    http-host-allowlist: ["*"]

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "common.names.fullname" . }}
  labels:
    {{- include "common.labels.standard" . | nindent 4 }}
{{- if .Values.encryptedDecryptionKey.enabled }}
stringData:
  # Encrypted ciphertext - will be decrypted by init container at runtime
  ENCRYPTED_DECRYPTION_KEY: {{ .Values.encryptedDecryptionKey.ciphertext | quote }}
  ENCRYPTION_PROVIDER: {{ .Values.encryptedDecryptionKey.provider | quote }}
  {{- if eq .Values.encryptedDecryptionKey.provider "aws" }}
  AWS_REGION: {{ .Values.encryptedDecryptionKey.aws.region | quote }}
  AWS_KMS_KEY_ID: {{ .Values.encryptedDecryptionKey.aws.keyId | quote }}
  {{- if .Values.encryptedDecryptionKey.aws.roleArn }}
  AWS_ROLE_ARN: {{ .Values.encryptedDecryptionKey.aws.roleArn | quote }}
  {{- end }}
  {{- else if eq .Values.encryptedDecryptionKey.provider "azure" }}
  AZURE_VAULT_NAME: {{ .Values.encryptedDecryptionKey.azure.vaultName | quote }}
  AZURE_KEY_NAME: {{ .Values.encryptedDecryptionKey.azure.keyName | quote }}
  {{- if .Values.encryptedDecryptionKey.azure.keyVersion }}
  AZURE_KEY_VERSION: {{ .Values.encryptedDecryptionKey.azure.keyVersion | quote }}
  {{- end }}
  AZURE_ALGORITHM: {{ .Values.encryptedDecryptionKey.azure.algorithm | quote }}
  {{- if .Values.encryptedDecryptionKey.azure.clientId }}
  AZURE_CLIENT_ID: {{ .Values.encryptedDecryptionKey.azure.clientId | quote }}
  {{- end }}
  {{- end }}
{{- else }}
data:
  # Plain text decryption key (legacy mode)
  DECRYPTION_KEY: {{ .Values.decryptionKey | b64enc | quote }}
{{- end }}